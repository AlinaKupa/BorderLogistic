<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="./styles.css" />
    <title>Редагувати чергу</title>
</head>

<body>
    <nav class="custom-navbar navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"> <img src="./images/Truck_icon_white.png" height="35px" alt="Truck icon" />
                Border
                Logistic</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="./index.html">Головна</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./queueRegistration.html">Стати в чергу</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./statistics.html">Статистика</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Контакти</a>
                    </li>

                </ul>
                <div class="col-md-3 text-end buttons">
                    <button type="button" class="btn btn-outline-light me-2">Зареєструватись</button>
                    <button type="button" class="btn btn-light">Увійти</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="bg-container">
        <div class="container register-contsiner">
            <main>
                <div class="py-5 text-center">
                    <img class="d-block mx-auto mb-4" src="./images/Truck_icon_white.png" alt="Truck icon" height="100">
                    <h2>Редагувати дані про чергу</h2>
                </div>

                <div class="row g-5 justify-content-center">

                    <div class="col-md-7 col-lg-8">
                        <h4 class="mb-3">Особисті дані</h4>
                        <form id="queueForm" class="needs-validation" novalidate="">
                            <div class="row g-3 align-items-end">
                                <div class="col-sm-6">
                                    <label for="fullName" class="form-label">ПІБ водія</label>
                                    <input type="text" class="form-control" id="fullName"
                                        placeholder="Прізвище Ім'я По-батькові" value="" required="">
                                    <div class="invalid-feedback">
                                        Вкажіть ПІБ водія
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <label for="foreignPassport" class="form-label">Серія та номер закордонного
                                        паспорта</label>
                                    <input type="text" class="form-control" id="foreignPassport" placeholder="ХХ000000"
                                        value="" required="">
                                    <div class="invalid-feedback">
                                        Вкажіть серію та номер закордонного паспорта
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="email" class="form-label">Електронна пошта <span
                                            class="text-body-secondary"></span></label>
                                    <input type="email" class="form-control" id="email" placeholder="email@gmail.com">
                                    <div class="invalid-feedback">
                                        Вкажіть адресу електоронної пошти
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="password" class="form-label">Пароль <span
                                            class="text-body-secondary"></span></label>
                                    <input type="password" class="form-control" id="password"
                                        placeholder="Введіть пароль" disabled>
                                    <div class="invalid-feedback">
                                        Вкажіть пароль
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="phoneNumber" class="form-label">Номер телефону</label>
                                    <input type="text" class="form-control" id="phoneNumber" placeholder="+380XXXXXXXXX"
                                        required="">
                                    <div class="invalid-feedback">
                                        Вкажіть номер телефону
                                    </div>
                                </div>

                                <h4 class="mb-2 mt-5">Дані транспортного засобу</h4>

                                <div class="col-md-6">
                                    <label for="registrationCountry" class="form-label">Країна реєстрації</label>
                                    <select class="form-select" id="registrationCountry" required="">
                                        <option value="">Обрати...</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Оберіть країну реєстрації транспортного засобу
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="checkpoint" class="form-label">Пункт пропуску</label>
                                    <select class="form-select" id="checkpoint" required="">
                                        <option value="">Обрати..</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Оберіть пункт пропуску
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <label for="cargoType" class="form-label">Категорія вантажу</label>
                                    <select class="form-select" id="cargoType" required="">
                                        <option value="">Обрати...</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Оберіть категорію товару
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="vehicleNumber" class="form-label">Номер ТЗ</label>
                                    <input type="text" class="form-control" id="vehicleNumber" placeholder="ХХ0000ХХ"
                                        required="">
                                    <div class="invalid-feedback">
                                        Вкажіть номер транспортного засобу
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="trailerNumber" class="form-label">Номер причепу</label>
                                    <input type="text" class="form-control" id="trailerNumber" placeholder="ХХ0000ХХ"
                                        required="">
                                    <div class="invalid-feedback">
                                        Вкажіть номер причепу
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="customsDeclaration" class="form-label">Митна декларація</label>
                                    <input type="text" class="form-control" id="customsDeclaration"
                                        placeholder="24UAXXXXXXXXXXXX" required="">
                                    <div class="invalid-feedback">
                                        Вкажіть номер митної декларації
                                    </div>
                                </div>
                            </div>


                            <hr class="my-4">
                            <div class="d-flex justify-content-center">
                                <button class="w-100 btn btn-dark btn-lg mb-5" type="submit">Оновити дані</button>
                            </div>

                        </form>
                        <script>
                            document.addEventListener("DOMContentLoaded", function () {
                                const urlParams = new URLSearchParams(window.location.search);
                                const queueId = urlParams.get('id');
                                const token = localStorage.getItem('token');

                                if (!queueId || !token) {
                                    alert('Помилка завантаження даних. Будь ласка, спробуйте знову.');
                                    window.location.href = 'userQueues.html';
                                    return;
                                }

                                async function fetchRegistrationCountries() {
                                    try {
                                        const token = localStorage.getItem('token');
                                        const response = await fetch('http://localhost:5000/api/queues/registrationCountries', {
                                            headers: {
                                                'Authorization': `Bearer ${token}`
                                            }
                                        });
                                        if (!response.ok) {
                                            throw new Error(`Server error: ${response.statusText}`);
                                        }
                                        const countries = await response.json();
                                        const countrySelect = document.getElementById('registrationCountry');
                                        countrySelect.innerHTML = '<option value="">Обрати...</option>'; 
                                        countries.forEach(country => {
                                            const option = document.createElement('option');
                                            option.value = country.id;
                                            option.textContent = country.country;
                                            countrySelect.appendChild(option);
                                        });
                                        countrySelect.addEventListener('change', function () {
                                            const selectedCountry = countrySelect.value;
                                            fetchCheckpoints(selectedCountry);
                                        });
                                    } catch (error) {
                                        console.error('Error fetching registration countries:', error);
                                        alert('Error fetching registration countries: ' + error.message);
                                    }

                                }

                                async function fetchCheckpoints(country) {
                                    try {
                                        const token = localStorage.getItem('token');
                                        const response = await fetch(`http://localhost:5000/api/queues/checkpoints/${country}`, {
                                            headers: {
                                                'Authorization': `Bearer ${token}`
                                            }
                                        });
                                        if (!response.ok) {
                                            throw new Error(`Server error: ${response.statusText}`);
                                        }
                                        const checkpoints = await response.json();
                                        const checkpointSelect = document.getElementById('checkpoint');
                                        checkpointSelect.innerHTML = '<option value="">Обрати...</option>'; 
                                        checkpoints.forEach(checkpoint => {
                                            const option = document.createElement('option');
                                            option.value = checkpoint.id;
                                            option.textContent = checkpoint.title;
                                            checkpointSelect.appendChild(option);
                                        });
                                    } catch (error) {
                                        console.error('Error fetching checkpoints:', error);
                                        alert('Error fetching checkpoints: ' + error.message);
                                    }
                                }

                                async function fetchCargoTypes(selectedCargoTypeId) {
                                    try {
                                        const token = localStorage.getItem('token');
                                        const response = await fetch('http://localhost:5000/api/queues/cargoTypes', {
                                            headers: {
                                                'Authorization': `Bearer ${token}`
                                            }
                                        });
                                        if (!response.ok) {
                                            throw new Error(`Server error: ${response.statusText}`);
                                        }
                                        const cargoTypes = await response.json();
                                        const cargoTypeSelect = document.getElementById('cargoType');
                                        cargoTypeSelect.innerHTML = '<option value="">Обрати...</option>'; 
                                        cargoTypes.forEach(cargoType => {
                                            const option = document.createElement('option');
                                            option.value = cargoType.id;
                                            option.textContent = cargoType.description;
                                            if (cargoType.id === selectedCargoTypeId) {
                                                option.selected = true;
                                            }
                                            cargoTypeSelect.appendChild(option);
                                        });
                                    } catch (error) {
                                        console.error('Error fetching cargo types:', error);
                                        alert('Error fetching cargo types: ' + error.message);
                                    }
                                }
                                async function fetchQueueData() {
                                    try {
                                        const queueResponse = await fetch(`http://localhost:5000/api/queues/queues/${queueId}`, {
                                            headers: {
                                                'Authorization': `Bearer ${token}`
                                            }
                                        });
                                        if (!queueResponse.ok) {
                                            throw new Error(`HTTP error! status: ${queueResponse.status}`);
                                        }
                                        const queueData = await queueResponse.json();

                                        document.getElementById('fullName').value = queueData.fullName;
                                        document.getElementById('foreignPassport').value = queueData.foreignPassport;
                                        document.getElementById('email').value = queueData.email;
                                        document.getElementById('password').value = queueData.password;
                                        document.getElementById('phoneNumber').value = queueData.phoneNumber;
                                        document.getElementById('vehicleNumber').value = queueData.vehicleNumber;
                                        document.getElementById('trailerNumber').value = queueData.trailerNumber;
                                        document.getElementById('cargoType').value = queueData.cargoType;
                                        document.getElementById('customsDeclaration').value = queueData.customsDeclaration;

                                        await fetchRegistrationCountries();
                                        document.getElementById('registrationCountry').value = queueData.registrationCountry;

                                        await fetchCheckpoints(queueData.registrationCountry);
                                        document.getElementById('checkpoint').value = queueData.checkpoint;

                                        await fetchCargoTypes(queueData.cargoType);
                                        document.getElementById('cargoType').value = queueData.cargoType;

                                    } catch (error) {
                                        console.error('Error fetching queue data:', error);
                                        alert('Помилка завантаження інформації про чергу');
                                    }
                                }

                                fetchQueueData();

                                document.getElementById('queueForm').addEventListener('submit', async function (e) {
                                    e.preventDefault();

                                    const updatedQueue = {
                                        fullName: document.getElementById('fullName').value,
                                        foreignPassport: document.getElementById('foreignPassport').value,
                                        email: document.getElementById('email').value,
                                        password: document.getElementById('password').value,
                                        phoneNumber: document.getElementById('phoneNumber').value,
                                        registrationCountry: document.getElementById('registrationCountry').value,
                                        checkpoint: document.getElementById('checkpoint').value,
                                        cargoType: document.getElementById('cargoType').value,
                                        vehicleNumber: document.getElementById('vehicleNumber').value,
                                        trailerNumber: document.getElementById('trailerNumber').value,
                                        customsDeclaration: document.getElementById('customsDeclaration').value,
                                        status: 'pending'
                                    };

                                    console.log('Submitting updated queue:', updatedQueue);

                                    try {
                                        const response = await fetch(`http://localhost:5000/api/queues/${queueId}`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify(updatedQueue)
                                        });

                                        const responseData = await response.json();

                                        if (response.ok) {
                                            console.log('Queue updated successfully:', responseData);
                                            alert('Черга успішно оновлена!');
                                            window.location.href = 'userQueues.html';
                                        } else {
                                            alert('Queue update failed: ' + response.statusText);
                                        }
                                    } catch (error) {
                                        alert('Error submitting form: ' + error.message);
                                    }
                                });
                            });

                        </script>

                    </div>
                </div>
            </main>

        </div>
    </div>

    <div class="custom-container container-fluid">
        <footer class="row row-cols-1 row-cols-sm-2 row-cols-md-5 py-5 my-5 border-top mb-0 mt-0">
            <div class="col-md-4 d-flex align-items-center">
                <a href="/" class="me-2 mb-3 me-2 mb-md-0 text-body-secondary text-decoration-none lh-1 mb-3">
                    <img src="./images/Truck_icon_white.png" alt="Truck icon" height="50px">
                </a>
                <span class="text-logo mb-3 mb-md-0 text-body-emphasis">© 2024 Border Logistic</span>
            </div>

            <div class="col mb-3 ms-auto">
                <h5>Опції</h5>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2"><a href="./index.html"
                            class="nav-link p-0 text-body-secondary">Головна</a></li>
                    <li class="nav-item mb-2"><a href="./queueRegistration.html"
                            class="nav-link p-0 text-body-secondary">Стати в чергу</a>
                    </li>
                    <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Статистика</a></li>
                </ul>
            </div>

            <div class="col mb-3">
                <h5>Контакти</h5>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">м. Чернігів, вул.
                            Шевченка 95</a></li>
                    <li class="nav-item mb-2"><a href="#"
                            class="nav-link p-0 text-body-secondary">borderlogic@gmail.com</a></li>
                    <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">+380991234567</a>
                    </li>
                </ul>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    </script>

</body>

</html>